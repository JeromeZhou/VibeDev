{% extends "base.html" %}
{% block title %}GPU-Insight è¶‹åŠ¿åˆ†æ{% endblock %}

{% block head %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
<style>
        .trend-pill {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 20px; font-size: 12px; font-weight: 600;
        }
        .trend-rising  { background: rgba(94,196,158,0.10); color: var(--accent-green); border: 1px solid rgba(94,196,158,0.18); }
        .trend-falling { background: rgba(229,83,75,0.10); color: var(--accent-red); border: 1px solid rgba(229,83,75,0.18); }
        .trend-new     { background: rgba(91,141,239,0.10); color: var(--accent-blue); border: 1px solid rgba(91,141,239,0.18); }
        .trend-stable  { background: rgba(86,88,105,0.12); color: var(--text-tertiary); border: 1px solid rgba(86,88,105,0.20); }

        .rank-change-list {
            max-height: 280px;
            overflow-y: auto;
            padding-right: 4px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.06) transparent;
        }
        .rank-change-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px; border-radius: 8px;
            border: 1px solid transparent;
            transition: background 0.2s, border-color 0.2s;
        }
        .rank-change-item:hover {
            background: var(--bg-hover);
            border-color: var(--border-default);
        }
        .summary-card {
            text-align: center; padding: 16px; border-radius: 8px;
        }
    </style>
{% endblock %}

{% block content %}
<!-- PPHI è¶‹åŠ¿å›¾ -->
        <div class="card p-6 mb-6 animate-in delay-1">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-semibold flex items-center gap-2">
                    <span class="material-icons" style="color: var(--accent-purple);">show_chart</span>
                    Top 5 ç—›ç‚¹ PPHI è¶‹åŠ¿
                </h2>
                <span class="text-xs mono" style="color: var(--text-tertiary);">æœ€è¿‘ 30 è½®</span>
            </div>
            <div style="position: relative; height: 280px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- æ’åæ¼”å˜ Bump Chart -->
        <div class="card p-6 mb-6 animate-in delay-2">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-semibold flex items-center gap-2">
                    <span class="material-icons" style="color: var(--accent-amber);">swap_vert</span>
                    ç—›ç‚¹æ’åæ¼”å˜
                </h2>
                <span class="text-xs mono" style="color: var(--text-tertiary);">Bump Chart Â· Top 8</span>
            </div>
            <div style="position: relative; height: 320px;">
                <canvas id="bumpChart"></canvas>
            </div>
        </div>

        <div class="grid grid-2 gap-4 mb-6">
            <!-- è®ºå›åˆ†å¸ƒ -->
            <div class="card p-6 animate-in delay-3">
                <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                    <span class="material-icons" style="color: var(--accent-green);">pie_chart</span>
                    æ•°æ®æºåˆ†å¸ƒ
                </h2>
                <div style="position: relative; height: 240px;">
                    <canvas id="sourceChart"></canvas>
                </div>
            </div>

            <!-- è¶‹åŠ¿å˜åŒ–åˆ—è¡¨ -->
            <div class="card p-6 animate-in delay-4">
                <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                    <span class="material-icons" style="color: var(--accent-blue);">swap_vert</span>
                    æ’åå˜åŠ¨
                </h2>
                <div class="rank-change-list space-y-1">
                    {% for r in rankings %}
                    <a href="/pain-point/{{ r.rank }}" class="rank-change-item">
                        <div class="flex items-center gap-3 min-w-0">
                            <span class="text-xs font-semibold mono" style="color: var(--text-tertiary); width: 20px; text-align: right;">#{{ r.rank }}</span>
                            <span class="trend-pill
                                {% if r.get('trend') == 'rising' %}trend-rising
                                {% elif r.get('trend') == 'falling' %}trend-falling
                                {% elif r.get('trend') == 'new' %}trend-new
                                {% else %}trend-stable{% endif %}">
                                {% if r.get('trend') == 'rising' %}â†‘
                                {% elif r.get('trend') == 'falling' %}â†“
                                {% elif r.get('trend') == 'new' %}â˜…
                                {% else %}â†’{% endif %}
                            </span>
                            <span class="text-sm truncate" style="color: var(--text-secondary);">{{ r.pain_point }}</span>
                        </div>
                        <div class="flex items-center gap-2" style="flex-shrink: 0; margin-left: 12px;">
                            <span class="text-sm font-semibold mono" style="color: var(--accent-blue);">{{ r.pphi_score }}</span>
                            <span class="material-icons" style="color: var(--text-tertiary); font-size: 18px;">chevron_right</span>
                        </div>
                    </a>
                    {% endfor %}
                    {% if not rankings %}
                    <div class="text-center py-6">
                        <span class="material-icons" style="color: var(--text-tertiary); font-size: 32px; margin-bottom: 8px; display: block;">hourglass_empty</span>
                        <p class="text-sm" style="color: var(--text-secondary);">ç­‰å¾…æ•°æ®é‡‡é›†...</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- åˆ†ææ‘˜è¦ -->
        <div class="card p-6 animate-in" style="animation-delay: 0.2s">
            <h2 class="text-base font-semibold mb-4 flex items-center gap-2">
                <span class="material-icons" style="color: var(--accent-amber);">analytics</span>
                è¶‹åŠ¿æ‘˜è¦
            </h2>
            <div class="grid grid-4 gap-4">
                {% set ns = namespace(rising=0, falling=0, new=0, stable=0, hot=0) %}
                {% for r in rankings %}
                    {% if r.get('trend') == 'hot' %}{% set ns.hot = ns.hot + 1 %}
                    {% elif r.get('trend') == 'rising' %}{% set ns.rising = ns.rising + 1 %}
                    {% elif r.get('trend') == 'falling' %}{% set ns.falling = ns.falling + 1 %}
                    {% elif r.get('trend') == 'new' %}{% set ns.new = ns.new + 1 %}
                    {% else %}{% set ns.stable = ns.stable + 1 %}{% endif %}
                {% endfor %}
                {% if ns.hot > 0 %}
                <div class="summary-card" style="background: rgba(255,68,68,0.06); border: 1px solid rgba(255,68,68,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--accent-red);">{{ ns.hot }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">çƒ­é—¨ ğŸ”¥</p>
                </div>
                {% endif %}
                <div class="summary-card" style="background: rgba(94,196,158,0.06); border: 1px solid rgba(94,196,158,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--accent-green);">{{ ns.rising }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">ä¸Šå‡ â†‘</p>
                </div>
                <div class="summary-card" style="background: rgba(229,83,75,0.06); border: 1px solid rgba(229,83,75,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--accent-red);">{{ ns.falling }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">ä¸‹é™ â†“</p>
                </div>
                <div class="summary-card" style="background: rgba(91,141,239,0.06); border: 1px solid rgba(91,141,239,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--accent-blue);">{{ ns.new }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">æ–°å¢ â˜…</p>
                </div>
                <div class="summary-card" style="background: rgba(86,88,105,0.06); border: 1px solid rgba(86,88,105,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--text-tertiary);">{{ ns.stable }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">ç¨³å®š â†’</p>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
<script>
    const trendData = {{ trend_data_json | safe }};
    const sourceData = {{ source_data_json | safe }};
    const evolutionData = {{ evolution_data_json | safe }};

    /* Chart.js color palette â€” synced with design system */
    function css(v) { return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
    var t = { text: css('--text-tertiary'), text2: css('--text-secondary'), tp: css('--text-primary'), grid: css('--chart-grid'), surf: css('--bg-elevated'), bdr: css('--border-default'), base: css('--bg-base') };
    const chartColors = ['#0070f3', '#8b5cf6', '#00dc82', '#ffaa00', '#ff4444'];

    // PPHI è¶‹åŠ¿æŠ˜çº¿å›¾
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    if (trendData.labels.length > 0) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: trendData.datasets.map((ds, i) => ({
                    ...ds,
                    borderColor: chartColors[i % chartColors.length],
                    backgroundColor: chartColors[i % chartColors.length],
                    tension: 0.3,
                    fill: false,
                    spanGaps: true,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    pointBackgroundColor: chartColors[i % chartColors.length],
                    pointBorderColor: t.base,
                    pointBorderWidth: 2,
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: t.text2, padding: 16, usePointStyle: true, pointStyleWidth: 8, font: { family: "'Inter', 'Noto Sans SC', sans-serif", size: 11 } }
                    },
                    tooltip: {
                        backgroundColor: t.surf, borderColor: t.bdr, borderWidth: 1,
                        titleColor: t.tp, bodyColor: t.text2, padding: 10, cornerRadius: 8,
                    }
                },
                scales: {
                    x: {
                        ticks: { color: t.text, font: { family: "'Inter', sans-serif", size: 11 } },
                        grid: { color: t.grid, drawBorder: false }
                    },
                    y: {
                        ticks: { color: t.text, font: { family: "'JetBrains Mono', monospace", size: 11 } },
                        grid: { color: t.grid, drawBorder: false }
                    }
                }
            }
        });
    } else {
        trendCtx.canvas.parentElement.innerHTML = '<div class="flex items-center justify-center" style="height:100%;color:var(--text-tertiary);font-size:14px;"><span class="material-icons" style="margin-right:8px;">hourglass_empty</span>éœ€è¦è‡³å°‘ 2 è½®æ•°æ®</div>';
    }

    // æ•°æ®æºåˆ†å¸ƒç¯å½¢å›¾
    const sourceCtx = document.getElementById('sourceChart').getContext('2d');
    if (sourceData.labels.length > 0) {
        const sourceColors = {
            'reddit': '#ff4444', 'nga': '#00dc82', 'tieba': '#ffaa00',
            'chiphell': '#0070f3', 'videocardz': '#8b5cf6',
            'bilibili': '#fb7299', 'v2ex': '#778087', 'mydrivers': '#1e88e5',
            'techpowerup': '#ff6f00'
        };
        const bgColors = sourceData.labels.map(l => sourceColors[l] || '#0070f3');

        new Chart(sourceCtx, {
            type: 'doughnut',
            data: {
                labels: sourceData.labels,
                datasets: [{
                    data: sourceData.data,
                    backgroundColor: bgColors,
                    borderColor: t.surf,
                    borderWidth: 2,
                    hoverBorderColor: t.base,
                    hoverOffset: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: t.text2, padding: 14, usePointStyle: true, pointStyleWidth: 8, font: { family: "'Inter', 'Noto Sans SC', sans-serif", size: 11 } }
                    },
                    tooltip: {
                        backgroundColor: t.surf, borderColor: t.bdr, borderWidth: 1,
                        titleColor: t.tp, bodyColor: t.text2, padding: 10, cornerRadius: 8,
                    }
                }
            }
        });
    } else {
        sourceCtx.canvas.parentElement.innerHTML = '<div class="flex items-center justify-center" style="height:100%;color:var(--text-tertiary);font-size:14px;"><span class="material-icons" style="margin-right:8px;">hourglass_empty</span>ç­‰å¾…æ•°æ®é‡‡é›†</div>';
    }

    // æ’åæ¼”å˜ Bump Chartï¼ˆY è½´åè½¬ï¼Œæ’å 1 åœ¨é¡¶éƒ¨ï¼‰
    const bumpCtx = document.getElementById('bumpChart').getContext('2d');
    if (evolutionData.dates && evolutionData.dates.length > 0 && evolutionData.series.length > 0) {
        new Chart(bumpCtx, {
            type: 'line',
            data: {
                labels: evolutionData.dates,
                datasets: evolutionData.series.map(s => ({
                    label: s.name,
                    data: s.data,
                    borderColor: s.color,
                    backgroundColor: s.color,
                    tension: 0.3,
                    fill: false,
                    spanGaps: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    borderWidth: 2.5,
                    pointBackgroundColor: s.color,
                    pointBorderColor: t.base,
                    pointBorderWidth: 2,
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: t.text2, padding: 14, usePointStyle: true, pointStyleWidth: 8, font: { family: "'Inter', 'Noto Sans SC', sans-serif", size: 11 } }
                    },
                    tooltip: {
                        backgroundColor: t.surf, borderColor: t.bdr, borderWidth: 1,
                        titleColor: t.tp, bodyColor: t.text2, padding: 10, cornerRadius: 8,
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': #' + ctx.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: t.text, font: { family: "'Inter', sans-serif", size: 11 } },
                        grid: { color: t.grid, drawBorder: false }
                    },
                    y: {
                        reverse: true,
                        min: 1,
                        ticks: {
                            color: t.text,
                            font: { family: "'JetBrains Mono', monospace", size: 11 },
                            stepSize: 1,
                            callback: function(val) { return '#' + val; }
                        },
                        grid: { color: t.grid, drawBorder: false }
                    }
                }
            }
        });
    } else {
        bumpCtx.canvas.parentElement.innerHTML = '<div class="flex items-center justify-center" style="height:100%;color:var(--text-tertiary);font-size:14px;"><span class="material-icons" style="margin-right:8px;">hourglass_empty</span>éœ€è¦è‡³å°‘ 2 è½®æ•°æ®æ‰èƒ½æ˜¾ç¤ºæ’åæ¼”å˜</div>';
    }
    </script>
{% endblock %}
