<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>趋势分析 — GPU-Insight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-base:     #0b0d14;
            --bg-surface:  #111318;
            --bg-elevated: #161922;
            --bg-hover:    #1c1f2b;
            --border-subtle:  rgba(255,255,255,0.06);
            --border-default: rgba(255,255,255,0.09);
            --border-strong:  rgba(255,255,255,0.14);
            --text-primary:   #ececf1;
            --text-secondary: #8b8fa3;
            --text-tertiary:  #565869;
            --accent-blue:    #5b8def;
            --accent-purple:  #9d8abf;
            --accent-green:   #5ec49e;
            --accent-red:     #e5534b;
            --accent-amber:   #d4a04a;
            --accent-silver:  #9ba3b0;
            --accent-bronze:  #b08952;
        }

        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            font-weight: 400;
        }
        .mono { font-family: 'JetBrains Mono', monospace; }

        .card {
            background: var(--bg-surface);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: border-color 0.2s ease;
        }
        .card:hover { border-color: var(--border-default); }

        .mesh-bg {
            background:
                radial-gradient(ellipse at 15% 50%, rgba(37,99,235,0.04) 0%, transparent 50%),
                radial-gradient(ellipse at 85% 15%, rgba(124,58,237,0.03) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 85%, rgba(5,150,105,0.03) 0%, transparent 50%);
        }

        .trend-pill {
            display: inline-flex; align-items: center; gap: 4px;
            padding: 2px 8px; border-radius: 20px; font-size: 12px; font-weight: 600;
        }
        .trend-rising  { background: rgba(94,196,158,0.10); color: var(--accent-green); border: 1px solid rgba(94,196,158,0.18); }
        .trend-falling { background: rgba(229,83,75,0.10); color: var(--accent-red); border: 1px solid rgba(229,83,75,0.18); }
        .trend-new     { background: rgba(91,141,239,0.10); color: var(--accent-blue); border: 1px solid rgba(91,141,239,0.18); }
        .trend-stable  { background: rgba(86,88,105,0.12); color: var(--text-tertiary); border: 1px solid rgba(86,88,105,0.20); }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-in { animation: fadeInUp 0.3s ease forwards; opacity: 0; }

        .nav-link {
            color: var(--text-secondary);
            font-size: 14px;
            display: flex; align-items: center; gap: 4px;
            transition: color 0.15s ease;
        }
        .nav-link:hover { color: var(--text-primary); }
    </style>
</head>
<body class="min-h-screen mesh-bg">
    <header class="py-4 px-6 border-b" style="border-color: var(--border-subtle);">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-lg flex items-center justify-center" style="background: var(--accent-purple);">
                    <span class="material-icons text-white text-base">trending_up</span>
                </div>
                <div>
                    <h1 class="text-lg font-semibold" style="color: var(--text-primary);">趋势分析</h1>
                    <p class="text-xs" style="color: var(--text-tertiary);">GPU-Insight · 痛点趋势追踪</p>
                </div>
            </div>
            <div class="flex gap-4 items-center">
                <a href="/" class="nav-link">
                    <span class="material-icons text-base">dashboard</span> 仪表盘
                </a>
                <a href="/report" class="nav-link">
                    <span class="material-icons text-base">description</span> 报告
                </a>
                <a href="/history" class="nav-link">
                    <span class="material-icons text-base">history</span> 历史
                </a>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto py-6 px-4">
        <!-- PPHI 趋势图 -->
        <div class="card p-6 mb-6 animate-in" style="animation-delay: 0.05s">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-semibold flex items-center gap-2" style="color: var(--text-primary);">
                    <span class="material-icons" style="color: var(--accent-purple);">show_chart</span>
                    Top 5 痛点 PPHI 趋势
                </h2>
                <span class="text-xs mono" style="color: var(--text-tertiary);">最近 10 轮</span>
            </div>
            <div style="position: relative; height: 280px;">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <!-- 排名演变 Bump Chart -->
        <div class="card p-6 mb-6 animate-in" style="animation-delay: 0.07s">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-semibold flex items-center gap-2" style="color: var(--text-primary);">
                    <span class="material-icons" style="color: var(--accent-amber);">swap_vert</span>
                    痛点排名演变
                </h2>
                <span class="text-xs mono" style="color: var(--text-tertiary);">Bump Chart · Top 8</span>
            </div>
            <div style="position: relative; height: 320px;">
                <canvas id="bumpChart"></canvas>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <!-- 论坛分布 -->
            <div class="card p-6 animate-in" style="animation-delay: 0.1s">
                <h2 class="text-base font-semibold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
                    <span class="material-icons" style="color: var(--accent-green);">pie_chart</span>
                    数据源分布
                </h2>
                <div style="position: relative; height: 240px;">
                    <canvas id="sourceChart"></canvas>
                </div>
            </div>

            <!-- 趋势变化列表 -->
            <div class="card p-6 animate-in" style="animation-delay: 0.15s">
                <h2 class="text-base font-semibold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
                    <span class="material-icons" style="color: var(--accent-blue);">swap_vert</span>
                    排名变动
                </h2>
                <div class="space-y-1 max-h-[280px] overflow-y-auto pr-1" style="scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.06) transparent;">
                    {% for r in rankings %}
                    <a href="/pain-point/{{ r.rank }}"
                       class="flex justify-between items-center p-3 rounded-lg transition-all duration-200 group"
                       style="border: 1px solid transparent;"
                       onmouseenter="this.style.background='var(--bg-hover)';this.style.borderColor='var(--border-default)'"
                       onmouseleave="this.style.background='transparent';this.style.borderColor='transparent'">
                        <div class="flex items-center gap-3 min-w-0">
                            <span class="text-xs font-semibold mono w-5 text-right" style="color: var(--text-tertiary);">#{{ r.rank }}</span>
                            <span class="trend-pill
                                {% if r.get('trend') == 'rising' %}trend-rising
                                {% elif r.get('trend') == 'falling' %}trend-falling
                                {% elif r.get('trend') == 'new' %}trend-new
                                {% else %}trend-stable{% endif %}">
                                {% if r.get('trend') == 'rising' %}↑
                                {% elif r.get('trend') == 'falling' %}↓
                                {% elif r.get('trend') == 'new' %}★
                                {% else %}→{% endif %}
                            </span>
                            <span class="text-sm truncate" style="color: var(--text-secondary);">{{ r.pain_point }}</span>
                        </div>
                        <div class="flex items-center gap-2 shrink-0 ml-3">
                            <span class="text-sm font-semibold mono" style="color: var(--accent-blue);">{{ r.pphi_score }}</span>
                            <span class="material-icons" style="color: var(--text-tertiary); font-size: 18px;">chevron_right</span>
                        </div>
                    </a>
                    {% endfor %}
                    {% if not rankings %}
                    <div class="text-center py-8">
                        <span class="material-icons text-3xl mb-2" style="color: var(--text-tertiary);">hourglass_empty</span>
                        <p class="text-sm" style="color: var(--text-secondary);">等待数据采集...</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 分析摘要 -->
        <div class="card p-6 animate-in" style="animation-delay: 0.2s">
            <h2 class="text-base font-semibold mb-4 flex items-center gap-2" style="color: var(--text-primary);">
                <span class="material-icons" style="color: var(--accent-amber);">analytics</span>
                趋势摘要
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% set ns = namespace(rising=0, falling=0, new=0, stable=0) %}
                {% for r in rankings %}
                    {% if r.get('trend') == 'rising' %}{% set ns.rising = ns.rising + 1 %}
                    {% elif r.get('trend') == 'falling' %}{% set ns.falling = ns.falling + 1 %}
                    {% elif r.get('trend') == 'new' %}{% set ns.new = ns.new + 1 %}
                    {% else %}{% set ns.stable = ns.stable + 1 %}{% endif %}
                {% endfor %}
                <div class="text-center p-4 rounded-lg" style="background: rgba(94,196,158,0.06); border: 1px solid rgba(94,196,158,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--accent-green);">{{ ns.rising }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">上升 ↑</p>
                </div>
                <div class="text-center p-4 rounded-lg" style="background: rgba(229,83,75,0.06); border: 1px solid rgba(229,83,75,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--accent-red);">{{ ns.falling }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">下降 ↓</p>
                </div>
                <div class="text-center p-4 rounded-lg" style="background: rgba(91,141,239,0.06); border: 1px solid rgba(91,141,239,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--accent-blue);">{{ ns.new }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">新增 ★</p>
                </div>
                <div class="text-center p-4 rounded-lg" style="background: rgba(86,88,105,0.06); border: 1px solid rgba(86,88,105,0.12);">
                    <p class="text-2xl font-semibold mono" style="color: var(--text-tertiary);">{{ ns.stable }}</p>
                    <p class="text-xs mt-1" style="color: var(--text-tertiary);">稳定 →</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="text-center text-xs py-6 mt-8" style="color: var(--text-tertiary); border-top: 1px solid var(--border-subtle);">
        GPU-Insight v1.0 · 显卡用户痛点智能分析系统
    </footer>

    <script>
    const trendData = {{ trend_data_json | safe }};
    const sourceData = {{ source_data_json | safe }};
    const evolutionData = {{ evolution_data_json | safe }};

    /* Chart.js color palette — synced with design system */
    const chartColors = ['#5b8def', '#9d8abf', '#5ec49e', '#d4a04a', '#e5534b'];

    // PPHI 趋势折线图
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    if (trendData.labels.length > 0) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: trendData.labels,
                datasets: trendData.datasets.map((ds, i) => ({
                    ...ds,
                    borderColor: chartColors[i % chartColors.length],
                    backgroundColor: chartColors[i % chartColors.length],
                    tension: 0.3,
                    fill: false,
                    spanGaps: true,
                    pointRadius: 3,
                    pointHoverRadius: 5,
                    borderWidth: 2,
                    pointBackgroundColor: chartColors[i % chartColors.length],
                    pointBorderColor: '#0b0d14',
                    pointBorderWidth: 2,
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#8b8fa3', padding: 16, usePointStyle: true, pointStyleWidth: 8, font: { family: "'Inter', 'Noto Sans SC', sans-serif", size: 11 } }
                    },
                    tooltip: {
                        backgroundColor: '#161922',
                        borderColor: 'rgba(255,255,255,0.09)',
                        borderWidth: 1,
                        titleColor: '#ececf1',
                        bodyColor: '#8b8fa3',
                        padding: 10,
                        cornerRadius: 8,
                        titleFont: { family: "'Inter', 'Noto Sans SC', sans-serif" },
                        bodyFont: { family: "'Inter', 'Noto Sans SC', sans-serif" },
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#565869', font: { family: "'Inter', sans-serif", size: 11 } },
                        grid: { color: 'rgba(255,255,255,0.04)', drawBorder: false }
                    },
                    y: {
                        ticks: { color: '#565869', font: { family: "'JetBrains Mono', monospace", size: 11 } },
                        grid: { color: 'rgba(255,255,255,0.04)', drawBorder: false }
                    }
                }
            }
        });
    } else {
        trendCtx.canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-sm" style="color: var(--text-tertiary);"><span class="material-icons mr-2">hourglass_empty</span>需要至少 2 轮数据</div>';
    }

    // 数据源分布环形图
    const sourceCtx = document.getElementById('sourceChart').getContext('2d');
    if (sourceData.labels.length > 0) {
        const sourceColors = {
            'reddit': '#e5534b', 'nga': '#5ec49e', 'tieba': '#d4a04a',
            'chiphell': '#5b8def', 'videocardz': '#9d8abf',
            'bilibili': '#fb7299', 'v2ex': '#778087', 'mydrivers': '#1e88e5',
            'techpowerup': '#ff6f00'
        };
        const bgColors = sourceData.labels.map(l => sourceColors[l] || '#5b8def');

        new Chart(sourceCtx, {
            type: 'doughnut',
            data: {
                labels: sourceData.labels,
                datasets: [{
                    data: sourceData.data,
                    backgroundColor: bgColors,
                    borderColor: '#111318',
                    borderWidth: 2,
                    hoverBorderColor: '#1c1f2b',
                    hoverOffset: 4,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#8b8fa3', padding: 14, usePointStyle: true, pointStyleWidth: 8, font: { family: "'Inter', 'Noto Sans SC', sans-serif", size: 11 } }
                    },
                    tooltip: {
                        backgroundColor: '#161922',
                        borderColor: 'rgba(255,255,255,0.09)',
                        borderWidth: 1,
                        titleColor: '#ececf1',
                        bodyColor: '#8b8fa3',
                        padding: 10,
                        cornerRadius: 8,
                        titleFont: { family: "'Inter', 'Noto Sans SC', sans-serif" },
                        bodyFont: { family: "'Inter', 'Noto Sans SC', sans-serif" },
                    }
                }
            }
        });
    } else {
        sourceCtx.canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-sm" style="color: var(--text-tertiary);"><span class="material-icons mr-2">hourglass_empty</span>等待数据采集</div>';
    }

    // 排名演变 Bump Chart（Y 轴反转，排名 1 在顶部）
    const bumpCtx = document.getElementById('bumpChart').getContext('2d');
    if (evolutionData.dates && evolutionData.dates.length > 0 && evolutionData.series.length > 0) {
        new Chart(bumpCtx, {
            type: 'line',
            data: {
                labels: evolutionData.dates,
                datasets: evolutionData.series.map(s => ({
                    label: s.name,
                    data: s.data,
                    borderColor: s.color,
                    backgroundColor: s.color,
                    tension: 0.3,
                    fill: false,
                    spanGaps: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    borderWidth: 2.5,
                    pointBackgroundColor: s.color,
                    pointBorderColor: '#0b0d14',
                    pointBorderWidth: 2,
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { color: '#8b8fa3', padding: 14, usePointStyle: true, pointStyleWidth: 8, font: { family: "'Inter', 'Noto Sans SC', sans-serif", size: 11 } }
                    },
                    tooltip: {
                        backgroundColor: '#161922',
                        borderColor: 'rgba(255,255,255,0.09)',
                        borderWidth: 1,
                        titleColor: '#ececf1',
                        bodyColor: '#8b8fa3',
                        padding: 10,
                        cornerRadius: 8,
                        callbacks: {
                            label: function(ctx) {
                                return ctx.dataset.label + ': #' + ctx.parsed.y;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: { color: '#565869', font: { family: "'Inter', sans-serif", size: 11 } },
                        grid: { color: 'rgba(255,255,255,0.04)', drawBorder: false }
                    },
                    y: {
                        reverse: true,
                        min: 1,
                        ticks: {
                            color: '#565869',
                            font: { family: "'JetBrains Mono', monospace", size: 11 },
                            stepSize: 1,
                            callback: function(val) { return '#' + val; }
                        },
                        grid: { color: 'rgba(255,255,255,0.04)', drawBorder: false }
                    }
                }
            }
        });
    } else {
        bumpCtx.canvas.parentElement.innerHTML = '<div class="flex items-center justify-center h-full text-sm" style="color: var(--text-tertiary);"><span class="material-icons mr-2">hourglass_empty</span>需要至少 2 轮数据才能显示排名演变</div>';
    }
    </script>
</body>
</html>
