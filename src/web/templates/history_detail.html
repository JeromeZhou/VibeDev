{% extends "base.html" %}
{% block title %}历史详情 — GPU-Insight{% endblock %}

{% block head %}
<style>
        /* page-specific: accordion expand icon */
        .expand-icon {
            transition: transform 0.2s;
        }
    </style>
{% endblock %}

{% block content %}
<div class="card p-6 animate-in">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-base font-semibold flex items-center gap-2" style="color: var(--text-primary);">
                    <span class="material-icons" style="color: var(--accent-amber);">leaderboard</span>
                    {{ run_date }} 排名
                </h2>
                <span class="text-xs mono" style="color: var(--text-tertiary);">共 {{ rankings | length }} 个痛点</span>
            </div>

            {% if rankings %}
            <div class="space-y-2">
                {% for r in rankings %}
                <div class="rounded-lg"
                     style="background: var(--bg-elevated); border: 1px solid var(--border-subtle); animation: fadeInUp 0.3s ease forwards; animation-delay: {{ loop.index * 0.03 }}s; opacity: 0;">
                    <div class="flex items-center gap-3 p-3 cursor-pointer"
                         onclick="toggleDetail(this)">
                        <div class="pphi-ring"
                             {% if r.rank == 1 %}style="border-color: var(--accent-amber);"
                             {% elif r.rank == 2 %}style="border-color: var(--accent-silver);"
                             {% elif r.rank == 3 %}style="border-color: var(--accent-bronze);"
                             {% else %}style="border-color: var(--accent-blue);"{% endif %}>
                            <span class="text-sm font-semibold mono"
                                  {% if r.rank == 1 %}style="color: var(--accent-amber);"
                                  {% elif r.rank == 2 %}style="color: var(--accent-silver);"
                                  {% elif r.rank == 3 %}style="color: var(--accent-bronze);"
                                  {% else %}style="color: var(--accent-blue);"{% endif %}>{{ r.pphi_score }}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-semibold mono"
                                      {% if r.rank == 1 %}style="color: var(--accent-amber);"
                                      {% elif r.rank == 2 %}style="color: var(--accent-silver);"
                                      {% elif r.rank == 3 %}style="color: var(--accent-bronze);"
                                      {% else %}style="color: var(--text-tertiary);"{% endif %}>#{{ r.rank }}</span>
                                <h3 class="font-medium text-sm truncate" style="color: var(--text-primary);">{{ r.pain_point }}</h3>
                            </div>
                            <div class="flex flex-wrap gap-1">
                                {% for m in r.get('gpu_tags', {}).get('models', [])[:4] %}
                                <span class="gpu-tag">{{ m }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="flex items-center gap-3" style="flex-shrink: 0; margin-left: 8px;">
                            <div class="text-xs mono" style="color: var(--text-tertiary);">{{ r.mentions }} disc.</div>
                            <span class="material-icons expand-icon" style="color: var(--text-tertiary); font-size: 20px;">expand_more</span>
                        </div>
                    </div>
                    <!-- Expandable detail -->
                    <div class="detail-panel" style="display: none; border-top: 1px solid var(--border-subtle);">
                        <div class="p-4 space-y-3">
                            {% set inferred = r.get('inferred_need') %}
                            {% if inferred and inferred.get('hidden_need') %}
                            <div class="flex items-start gap-2">
                                <span class="material-icons text-sm" style="color: var(--accent-purple); flex-shrink: 0; margin-top: 2px;">psychology</span>
                                <div class="flex-1">
                                    <p class="text-xs font-medium mb-1" style="color: var(--text-tertiary);">AI Inferred Need</p>
                                    <p class="text-sm" style="color: var(--accent-purple);">{{ inferred.hidden_need }}</p>
                                    {% if inferred.get('reasoning_chain') %}
                                    <div class="mt-2 p-3 rounded-lg" style="background: var(--bg-surface); border-left: 2px solid var(--accent-purple);">
                                        <p class="text-xs mb-1" style="color: var(--text-tertiary);">推理链</p>
                                        <ol style="padding-left: 16px;">
                                            {% for step in inferred.reasoning_chain %}
                                            <li class="text-xs mb-1" style="color: var(--text-secondary);">{{ step }}</li>
                                            {% endfor %}
                                        </ol>
                                    </div>
                                    {% endif %}
                                    {% set munger = inferred.get('munger_review') %}
                                    {% if munger %}
                                    {% set ql = munger.get('quality_level', 'unknown') %}
                                    <div class="mt-2 flex items-center gap-2">
                                        <span class="text-xs" style="color: var(--text-tertiary);">Munger:</span>
                                        {% if ql == 'strong' %}
                                        <span class="text-xs font-medium" style="color: var(--accent-green);">✓ Strong</span>
                                        {% elif ql == 'moderate' %}
                                        <span class="text-xs font-medium" style="color: var(--accent-amber);">◐ Moderate</span>
                                        {% else %}
                                        <span class="text-xs font-medium" style="color: var(--accent-red);">✗ Weak</span>
                                        {% endif %}
                                        {% if munger.get('comment') %}
                                        <span class="text-xs" style="color: var(--text-tertiary); font-style: italic;">"{{ munger.comment[:80] }}"</span>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    <div class="mt-1">
                                        <span class="text-xs mono" style="color: var(--text-tertiary);">置信度: {{ (inferred.get('confidence', 0) * 100) | int }}%</span>
                                    </div>
                                </div>
                            </div>
                            {% elif r.get('hidden_need') %}
                            <div class="flex items-start gap-2">
                                <span class="material-icons text-sm" style="color: var(--accent-purple); flex-shrink: 0; margin-top: 2px;">psychology</span>
                                <div>
                                    <p class="text-xs font-medium mb-1" style="color: var(--text-tertiary);">AI Inferred Need</p>
                                    <p class="text-sm" style="color: var(--accent-purple);">{{ r.hidden_need }}</p>
                                </div>
                            </div>
                            {% endif %}
                            {% if r.get('gpu_tags', {}).get('models') %}
                            <div class="flex items-start gap-2">
                                <span class="material-icons text-sm" style="color: var(--accent-green); flex-shrink: 0; margin-top: 2px;">memory</span>
                                <div>
                                    <p class="text-xs font-medium mb-1" style="color: var(--text-tertiary);">GPU Models</p>
                                    <div class="flex flex-wrap gap-1">
                                        {% for m in r.get('gpu_tags', {}).get('models', []) %}
                                        <span class="gpu-tag">{{ m }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if r.get('gpu_tags', {}).get('manufacturers') %}
                            <div class="flex items-start gap-2">
                                <span class="material-icons text-sm" style="color: var(--accent-green); flex-shrink: 0; margin-top: 2px;">factory</span>
                                <div>
                                    <p class="text-xs font-medium mb-1" style="color: var(--text-tertiary);">Manufacturers</p>
                                    <div class="flex flex-wrap gap-1">
                                        {% for mfr in r.get('gpu_tags', {}).get('manufacturers', []) %}
                                        <span class="mfr-tag">{{ mfr }}</span>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% if r.get('source_urls') %}
                            <div class="flex items-start gap-2">
                                <span class="material-icons text-sm" style="color: var(--accent-blue); flex-shrink: 0; margin-top: 2px;">link</span>
                                <div class="min-w-0 flex-1">
                                    <p class="text-xs font-medium mb-1" style="color: var(--text-tertiary);">Sources</p>
                                    {% for url in r.get('source_urls', [])[:5] %}
                                    <a href="{{ url }}" target="_blank" rel="noopener"
                                       class="block text-xs truncate mb-1" style="color: var(--accent-blue);">{{ url }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}
                            {% if not r.get('hidden_need') and not r.get('inferred_need') and not r.get('source_urls') and not r.get('gpu_tags', {}).get('models') %}
                            <p class="text-xs" style="color: var(--text-tertiary);">No additional details for this run.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center" style="padding: 48px 0;">
                <span class="material-icons mb-2" style="font-size: 36px; color: var(--text-tertiary);">search_off</span>
                <p style="color: var(--text-secondary);">该轮次无数据</p>
            </div>
            {% endif %}
        </div>
{% endblock %}

{% block scripts %}
<script>
    function toggleDetail(header) {
        var panel = header.nextElementSibling;
        var icon = header.querySelector('.expand-icon');
        if (panel.style.display === 'none') {
            panel.style.display = 'block';
            icon.style.transform = 'rotate(180deg)';
            header.parentElement.style.borderColor = 'var(--border-default)';
        } else {
            panel.style.display = 'none';
            icon.style.transform = 'rotate(0deg)';
            header.parentElement.style.borderColor = 'var(--border-subtle)';
        }
    }
    </script>
{% endblock %}
