<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPU-Insight 后台管理</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+SC:wght@400;500;600&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    <link href="/static/base.css" rel="stylesheet">
    <script src="/static/theme.js"></script>
    <style>
        .status-green { color: var(--accent-green); }
        .status-yellow { color: var(--accent-amber); }
        .status-red { color: var(--accent-red); }
        .status-dot {
            width: 8px; height: 8px; border-radius: 50%; display: inline-block;
        }
        .status-dot.green { background: var(--accent-green); }
        .status-dot.yellow { background: var(--accent-amber); }
        .status-dot.red { background: var(--accent-red); }
        .alert-ok { background: rgba(94,196,158,0.08); border-left: 3px solid var(--accent-green); }
        .alert-warning { background: rgba(212,160,74,0.08); border-left: 3px solid var(--accent-amber); }
        .alert-error { background: rgba(229,83,75,0.08); border-left: 3px solid var(--accent-red); }
        .tag {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 12px; margin: 2px;
        }
        .tag-pain { background: rgba(229,83,75,0.12); color: #e5534b; }
        .tag-model { background: rgba(91,141,239,0.12); color: #5b8def; }
        .tag-hot { background: rgba(212,160,74,0.12); color: #d4a04a; }
        .tag-signal { background: rgba(157,138,191,0.12); color: #9d8abf; }
        .progress-bar {
            height: 8px; border-radius: 4px; background: var(--bg-elevated);
            overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 4px; transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- 导航 -->
    <nav class="site-nav">
        <span class="nav-brand"><span class="material-icons">insights</span> GPU-Insight</span>
        <a href="/"><span class="material-icons">dashboard</span> 仪表盘</a>
        <a href="/gpu-models"><span class="material-icons">memory</span> 型号</a>
        <a href="/trends"><span class="material-icons">trending_up</span> 趋势</a>
        <a href="/history"><span class="material-icons">history</span> 历史</a>
        <a href="/report"><span class="material-icons">description</span> 报告</a>
        <a href="/admin" class="active"><span class="material-icons">admin_panel_settings</span> 管理</a>
        <span class="nav-spacer"></span>
        <button class="theme-toggle" onclick="toggleTheme()"><span class="material-icons theme-icon">light_mode</span></button>
    </nav>

    <main class="page-container">
        <h1 style="font-size: 20px; font-weight: 600; margin-bottom: 24px;">
            <span class="material-icons" style="vertical-align: middle; font-size: 22px; color: var(--accent-blue);">admin_panel_settings</span>
            后台管理
        </h1>

        <!-- 异常告警 -->
        {% for alert in alerts %}
        <div class="alert-{{ alert.level }}" style="padding: 10px 16px; border-radius: 8px; margin-bottom: 8px; font-size: 14px;">
            {% if alert.level == 'error' %}
            <span class="material-icons" style="font-size: 16px; vertical-align: middle; color: var(--accent-red);">error</span>
            {% elif alert.level == 'warning' %}
            <span class="material-icons" style="font-size: 16px; vertical-align: middle; color: var(--accent-amber);">warning</span>
            {% else %}
            <span class="material-icons" style="font-size: 16px; vertical-align: middle; color: var(--accent-green);">check_circle</span>
            {% endif %}
            {{ alert.msg }}
        </div>
        {% endfor %}

        <!-- 统计卡片 -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin: 20px 0;">
            <div class="card" style="padding: 16px;">
                <div style="color: var(--text-tertiary); font-size: 12px;">累计帖子</div>
                <div class="mono" style="font-size: 28px; font-weight: 600;">{{ stats.total_posts }}</div>
            </div>
            <div class="card" style="padding: 16px;">
                <div style="color: var(--text-tertiary); font-size: 12px;">分析轮次</div>
                <div class="mono" style="font-size: 28px; font-weight: 600;">{{ stats.total_runs }}</div>
            </div>
            <div class="card" style="padding: 16px;">
                <div style="color: var(--text-tertiary); font-size: 12px;">月度成本</div>
                <div class="mono" style="font-size: 28px; font-weight: 600;">${{ cost.monthly }}</div>
                <div class="progress-bar" style="margin-top: 8px;">
                    <div class="progress-fill" style="width: {{ cost.pct }}%; background: {% if cost.pct > 90 %}var(--accent-red){% elif cost.pct > 80 %}var(--accent-amber){% else %}var(--accent-green){% endif %};"></div>
                </div>
                <div style="color: var(--text-tertiary); font-size: 11px; margin-top: 4px;">{{ cost.pct }}% / ${{ cost.budget }}</div>
            </div>
            <div class="card" style="padding: 16px;">
                <div style="color: var(--text-tertiary); font-size: 12px;">信号词库</div>
                <div class="mono" style="font-size: 28px; font-weight: 600;">{{ keywords.signals_count }}</div>
                <div style="color: var(--text-tertiary); font-size: 11px; margin-top: 4px;">中英文合计</div>
            </div>
        </div>

        <!-- 两列布局 -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">

            <!-- 左列：数据源健康 -->
            <div class="card" style="padding: 20px;">
                <div class="section-title">
                    <span class="material-icons" style="font-size: 16px;">dns</span>
                    数据源健康
                </div>
                <table>
                    <thead>
                        <tr><th>来源</th><th>状态</th><th>本轮</th><th>累计</th><th>更新</th></tr>
                    </thead>
                    <tbody>
                        {% for s in sources %}
                        <tr>
                            <td style="font-weight: 500;">{{ s.name }}</td>
                            <td><span class="status-dot {{ s.status }}"></span></td>
                            <td class="mono">{{ s.last_count }}</td>
                            <td class="mono">{{ s.total }}</td>
                            <td style="color: var(--text-secondary); font-size: 12px;">{{ s.last_at }}</td>
                        </tr>
                        {% endfor %}
                        {% if not sources %}
                        <tr><td colspan="5" style="color: var(--text-tertiary); text-align: center;">暂无数据</td></tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- 右列：搜索关键词 -->
            <div class="card" style="padding: 20px;">
                <div class="section-title">
                    <span class="material-icons" style="font-size: 16px;">search</span>
                    搜索关键词
                </div>

                <div style="margin-bottom: 16px;">
                    <div style="color: var(--text-tertiary); font-size: 12px; margin-bottom: 6px;">Bilibili ({{ keywords.bilibili|length }} 词)</div>
                    {% for kw in keywords.bilibili %}
                    <span class="tag tag-pain">{{ kw }}</span>
                    {% endfor %}
                </div>

                <div style="margin-bottom: 16px;">
                    <div style="color: var(--text-tertiary); font-size: 12px; margin-bottom: 6px;">Reddit ({{ keywords.reddit|length }} 词)</div>
                    {% for kw in keywords.reddit %}
                    <span class="tag tag-model">{{ kw }}</span>
                    {% endfor %}
                </div>

                <div>
                    <div style="color: var(--text-tertiary); font-size: 12px; margin-bottom: 6px;">
                        热词发现
                        <span class="mono" style="font-size: 11px;">
                            {{ keywords.discovered.zh_count }}/{{ keywords.discovered.zh_capacity }} 中文,
                            {{ keywords.discovered.en_count }}/{{ keywords.discovered.en_capacity }} 英文
                        </span>
                        {% if keywords.discovered.last_updated %}
                        <span style="font-size: 11px; color: var(--text-tertiary);">· {{ keywords.discovered.last_updated }}</span>
                        {% endif %}
                    </div>
                    {% if keywords.discovered.zh %}
                        {% for item in keywords.discovered.zh %}
                        <span class="tag tag-hot" title="出现{{ item.total_mentions }}次 | 衰减{{ item.decay_score }}">
                            {{ item.word }}
                            <span class="mono" style="font-size: 10px; opacity: 0.6;">×{{ item.total_mentions }}</span>
                        </span>
                        {% endfor %}
                    {% else %}
                        <span style="color: var(--text-tertiary); font-size: 12px;">暂无自动发现的热词</span>
                    {% endif %}
                    {% if keywords.discovered.en %}
                        <div style="margin-top: 6px;">
                        {% for item in keywords.discovered.en %}
                        <span class="tag tag-hot" title="出现{{ item.total_mentions }}次 | 衰减{{ item.decay_score }}">
                            {{ item.word }}
                            <span class="mono" style="font-size: 10px; opacity: 0.6;">×{{ item.total_mentions }}</span>
                        </span>
                        {% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- 系统信息 -->
        <div class="card" style="padding: 20px; margin-top: 16px;">
            <div class="section-title">
                <span class="material-icons" style="font-size: 16px;">info</span>
                系统信息
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; font-size: 13px;">
                <div>
                    <span style="color: var(--text-tertiary);">数据源</span>
                    <span class="mono">{{ sources|length }} 个活跃</span>
                </div>
                <div>
                    <span style="color: var(--text-tertiary);">预算状态</span>
                    <span class="status-{% if cost.status == 'normal' %}green{% elif cost.status == 'warning' %}yellow{% else %}red{% endif %}">
                        {{ cost.status }}
                    </span>
                </div>
                <div>
                    <span style="color: var(--text-tertiary);">热词衰减</span>
                    <span class="mono">14天周期</span>
                </div>
                <div>
                    <span style="color: var(--text-tertiary);">MIN_DATE</span>
                    <span class="mono">2025-01-01</span>
                </div>
                <div>
                    <span style="color: var(--text-tertiary);">L2 batch_size</span>
                    <span class="mono">25</span>
                </div>
                <div>
                    <span style="color: var(--text-tertiary);">版本</span>
                    <span class="mono">v9</span>
                </div>
            </div>
        </div>

        <!-- AI 相关性过滤 -->
        <div class="card" style="padding: 20px; margin-top: 16px;">
            <div class="section-title">
                <span class="material-icons" style="font-size: 16px;">filter_alt</span>
                AI 相关性过滤
            </div>
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 16px;">
                <div style="text-align: center;">
                    <div style="color: var(--text-tertiary); font-size: 12px;">已判断</div>
                    <div class="mono" style="font-size: 24px; font-weight: 600;">{{ filter_stats.total }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--text-tertiary); font-size: 12px;">保留</div>
                    <div class="mono" style="font-size: 24px; font-weight: 600; color: var(--accent-green);">{{ filter_stats.kept }}</div>
                </div>
                <div style="text-align: center;">
                    <div style="color: var(--text-tertiary); font-size: 12px;">排除</div>
                    <div class="mono" style="font-size: 24px; font-weight: 600; color: var(--accent-red);">{{ filter_stats.dropped }}</div>
                </div>
            </div>
            {% if filter_stats.total > 0 %}
            <div class="progress-bar" style="margin-bottom: 12px;">
                <div class="progress-fill" style="width: {{ (filter_stats.kept / filter_stats.total * 100) | round(1) if filter_stats.total > 0 else 0 }}%; background: var(--accent-green);"></div>
            </div>
            <div style="color: var(--text-tertiary); font-size: 11px; margin-bottom: 16px;">
                保留率 {{ (filter_stats.kept / filter_stats.total * 100) | round(1) if filter_stats.total > 0 else 0 }}%
            </div>
            {% endif %}

            {% if filter_stats.recent_drops %}
            <div style="margin-top: 8px;">
                <div style="color: var(--text-tertiary); font-size: 12px; margin-bottom: 8px;">
                    最近排除的帖子（人工复查）
                    <span class="mono" style="font-size: 11px;">共 {{ filter_stats.recent_drops|length }} 条</span>
                </div>
                <div style="max-height: 200px; overflow-y: auto;">
                    {% for drop in filter_stats.recent_drops %}
                    <div style="padding: 6px 0; border-bottom: 1px solid var(--border-subtle); font-size: 12px;">
                        <span class="tag tag-model" style="font-size: 10px;">{{ drop.source }}</span>
                        <span style="color: var(--text-secondary);">{{ drop.title[:60] }}</span>
                        {% if drop.relevance_reason %}
                        <span style="color: var(--text-tertiary); font-size: 10px; margin-left: 4px;">{{ drop.relevance_reason[:40] }}</span>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div style="color: var(--text-tertiary); font-size: 12px;">暂无过滤数据（等待首次 pipeline 运行）</div>
            {% endif %}
        </div>
    </main>

    <footer class="living-footer">
        <span class="footer-status">
            <span class="footer-dot"></span>
            GPU-Insight · AI 持续分析中
        </span>
    </footer>
</body>
</html>
